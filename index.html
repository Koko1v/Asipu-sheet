<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asipu Analytics Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.1.0/dist/handsontable.full.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 400px;
        }

        .login-box h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .login-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 16px;
        }

        .login-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-box button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-box button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .error-msg {
            color: #ef4444;
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        /* Main Dashboard */
        #app {
            display: none;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-role {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .logout-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: white;
            color: #667eea;
        }

        /* Version History Sidebar */
        .version-history-sidebar {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            transition: right 0.3s;
            z-index: 1000;
            overflow-y: auto;
        }

        .version-history-sidebar.open {
            right: 0;
        }

        .version-history-header {
            background: #667eea;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .version-history-header h2 {
            font-size: 20px;
        }

        .close-history-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .version-list {
            padding: 0;
        }

        .version-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
        }

        .version-item:hover {
            background: #f9fafb;
        }

        .version-item.active {
            background: #eff6ff;
            border-left: 4px solid #667eea;
        }

        .version-time {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .version-user {
            font-size: 12px;
            color: #9ca3af;
        }

        .version-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .restore-btn, .preview-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .restore-btn {
            background: #10b981;
            color: white;
        }

        .restore-btn:hover {
            background: #059669;
        }

        .preview-btn {
            background: #667eea;
            color: white;
        }

        .preview-btn:hover {
            background: #5568d3;
        }

        .current-version-badge {
            background: #fbbf24;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }

        .no-versions {
            padding: 40px 20px;
            text-align: center;
            color: #9ca3af;
        }

        /* Domain Selection */
        .domain-tabs {
            display: flex;
            gap: 10px;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .domain-tab {
            padding: 15px 30px;
            background: #e5e7eb;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .domain-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .domain-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Dashboard Sections */
        .dashboard-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            padding: 20px;
            margin: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .section-card {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            padding: 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .section-card.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: scale(1.05);
        }

        .section-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .section-card h3 {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .section-card .value {
            font-size: 28px;
            font-weight: 700;
        }

        .section-card .label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* Time Navigation */
        .time-navigation {
            padding: 20px;
            background: white;
            margin: 0 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .nav-section {
            margin-bottom: 15px;
        }

        .nav-label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            font-size: 14px;
        }

        .year-buttons, .month-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .year-btn, .month-btn {
            padding: 10px 20px;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .year-btn.active, .month-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .year-btn:hover, .month-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
        }

        /* Toolbar */
        .toolbar {
            background: white;
            padding: 15px 20px;
            margin: 0 20px 20px 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        .btn-warning {
            background: #f59e0b;
        }

        .btn-warning:hover:not(:disabled) {
            background: #d97706;
        }

        /* Container */
        .container {
            padding: 0 20px 20px 20px;
        }

        #spreadsheet {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .file-input {
            display: none;
        }

        .current-view {
            padding: 15px 20px;
            background: #f9fafb;
            margin: 0 20px 20px 20px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            color: #667eea;
            font-size: 18px;
        }

        .preview-mode-banner {
            background: #fbbf24;
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .preview-mode-banner.active {
            display: block;
        }

        .view-only-banner {
            background: #ef4444;
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .view-only-banner.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h1>üîê Asipu Analytics</h1>
            <input type="text" id="username" placeholder="Username" />
            <input type="password" id="password" placeholder="Password" />
            <button onclick="login()">Login</button>
            <div class="error-msg" id="errorMsg">Invalid credentials</div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app">
        <div class="header">
            <h1>üìä Asipu Analytics Dashboard</h1>
            <div class="user-info">
                <span class="user-name" id="userName"></span>
                <span class="user-role" id="userRole"></span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- View Only Banner -->
        <div class="view-only-banner" id="viewOnlyBanner">
            üîí VIEW ONLY MODE - You can only view data. No editing allowed.
        </div>

        <!-- Preview Mode Banner -->
        <div class="preview-mode-banner" id="previewBanner">
            üìã PREVIEW MODE - Viewing previous version
        </div>

        <!-- Version History Sidebar -->
        <div class="version-history-sidebar" id="versionHistorySidebar">
            <div class="version-history-header">
                <h2>üìú Version History</h2>
                <button class="close-history-btn" onclick="closeVersionHistory()">‚úï</button>
            </div>
            <div class="version-list" id="versionList"></div>
        </div>

        <!-- Domain Selection -->
        <div class="domain-tabs">
            <button class="domain-tab active" onclick="switchDomain('asipu.de')">Asipu.de</button>
            <button class="domain-tab" onclick="switchDomain('asipu.fi')">Asipu.fi</button>
        </div>

        <!-- Dashboard Sections -->
        <div class="dashboard-sections">
            <div class="section-card active" onclick="selectSection('raw-data')">
                <h3>üìä Raw Data</h3>
                <div class="value" id="rawDataCount">0</div>
                <div class="label">Daily Records</div>
            </div>
            <div class="section-card" onclick="selectSection('fb-ads')">
                <h3>üì± FB Ads</h3>
                <div class="value" id="fbAdsSpend">‚Ç¨0</div>
                <div class="label">Total Spend</div>
            </div>
            <div class="section-card" onclick="selectSection('revenue')">
                <h3>üí∞ Revenue</h3>
                <div class="value" id="totalRevenue">‚Ç¨0</div>
                <div class="label">Sales Revenue</div>
            </div>
            <div class="section-card" onclick="selectSection('orders')">
                <h3>üì¶ Orders</h3>
                <div class="value" id="totalOrders">0</div>
                <div class="label">Total Orders</div>
            </div>
            <div class="section-card" onclick="selectSection('profit')">
                <h3>üíµ Profit</h3>
                <div class="value" id="netProfit">‚Ç¨0</div>
                <div class="label">Net Profit</div>
            </div>
            <div class="section-card" onclick="selectSection('products')">
                <h3>üè∑Ô∏è Products</h3>
                <div class="value" id="productCount">8</div>
                <div class="label">Active Products</div>
            </div>
        </div>

        <!-- Time Navigation -->
        <div class="time-navigation">
            <div class="nav-section">
                <div class="nav-label">Select Year:</div>
                <div class="year-buttons" id="yearButtons"></div>
            </div>
            <div class="nav-section">
                <div class="nav-label">Select Month:</div>
                <div class="month-buttons" id="monthButtons"></div>
            </div>
        </div>

        <div class="current-view" id="currentView">Asipu.de - 2025 - January - Raw Data View</div>

        <!-- Toolbar -->
        <div class="toolbar" id="toolbar">
            <button class="btn" id="addBtn" onclick="addRow()">‚ûï Add Day</button>
            <button class="btn" id="saveBtn" onclick="saveData()">üíæ Save Data</button>
            <button class="btn btn-warning" onclick="openVersionHistory()">üìú Version History</button>
            <button class="btn btn-success" onclick="exportToExcel()">üì• Export Excel</button>
            <label for="file-upload" class="btn" id="importLabel">üìÇ Import Excel</label>
            <input id="file-upload" type="file" class="file-input" accept=".xlsx,.xls" onchange="importExcel(event)">
        </div>

        <!-- Spreadsheet -->
        <div class="container">
            <div id="spreadsheet"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/handsontable@13.1.0/dist/handsontable.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // User Management System with Roles
        const users = {
            'Mohammed': { password: 'admin123', role: 'super_admin', displayName: 'Mohammed' },
            'Erica': { password: 'editor123', role: 'editor', displayName: 'Erica' },
            'asipu-team': { password: 'viewer123', role: 'viewer', displayName: 'Asipu Team' }
        };

        let currentUser = null;

        // Check if user is logged in
        window.onload = function() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                currentUser = JSON.parse(loggedInUser);
                showApp(currentUser);
            }
        };

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (users[username] && users[username].password === password) {
                currentUser = users[username];
                localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                showApp(currentUser);
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
        }

        function showApp(user) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('userName').textContent = user.displayName;

            // Set role badge
            const roleText = user.role === 'super_admin' ? 'Full Admin' : 
                           user.role === 'editor' ? 'Editor Admin' : 'View Only';
            document.getElementById('userRole').textContent = roleText;

            // Apply role restrictions
            applyRoleRestrictions(user.role);

            initializeApp();
        }

        function applyRoleRestrictions(role) {
            if (role === 'viewer') {
                document.getElementById('viewOnlyBanner').classList.add('active');
                document.getElementById('addBtn').disabled = true;
                document.getElementById('saveBtn').disabled = true;
                document.getElementById('importLabel').style.display = 'none';
            }
        }

        function logout() {
            localStorage.removeItem('loggedInUser');
            location.reload();
        }

        // Application State
        let currentDomain = 'asipu.de';
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let currentSection = 'raw-data';
        let hot;
        let previewMode = false;

        const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];

        // Initialize App
        function initializeApp() {
            generateYearButtons();
            generateMonthButtons();
            initializeSpreadsheet();
            updateCurrentView();
        }

        // Generate Year Buttons
        function generateYearButtons() {
            const container = document.getElementById('yearButtons');
            const currentYearNum = new Date().getFullYear();

            for (let year = currentYearNum - 2; year <= currentYearNum + 2; year++) {
                const btn = document.createElement('button');
                btn.className = 'year-btn' + (year === currentYear ? ' active' : '');
                btn.textContent = year;
                btn.onclick = () => selectYear(year);
                container.appendChild(btn);
            }
        }

        // Generate Month Buttons
        function generateMonthButtons() {
            const container = document.getElementById('monthButtons');
            months.forEach((month, index) => {
                const btn = document.createElement('button');
                btn.className = 'month-btn' + (index === currentMonth ? ' active' : '');
                btn.textContent = month;
                btn.onclick = () => selectMonth(index);
                container.appendChild(btn);
            });
        }

        // Select Section
        function selectSection(section) {
            currentSection = section;
            document.querySelectorAll('.section-card').forEach(card => card.classList.remove('active'));
            event.target.closest('.section-card').classList.add('active');
            updateCurrentView();
        }

        // Switch Domain
        function switchDomain(domain) {
            currentDomain = domain;
            document.querySelectorAll('.domain-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase().includes(domain)) {
                    tab.classList.add('active');
                }
            });
            exitPreviewMode();
            loadData();
            updateCurrentView();
        }

        // Select Year
        function selectYear(year) {
            currentYear = year;
            document.querySelectorAll('.year-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent == year) {
                    btn.classList.add('active');
                }
            });
            exitPreviewMode();
            loadData();
            updateCurrentView();
        }

        // Select Month
        function selectMonth(monthIndex) {
            currentMonth = monthIndex;
            document.querySelectorAll('.month-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.month-btn')[monthIndex].classList.add('active');
            exitPreviewMode();
            loadData();
            updateCurrentView();
        }

        // Update Current View Display
        function updateCurrentView() {
            const sectionName = currentSection.replace('-', ' ').toUpperCase();
            const view = `${currentDomain.toUpperCase()} - ${currentYear} - ${months[currentMonth]} - ${sectionName}`;
            document.getElementById('currentView').textContent = view;
        }

        // Column Configuration matching Excel structure
        const columns = [
            { data: 0, type: 'date', dateFormat: 'YYYY-MM-DD', title: 'Date', width: 100 },
            { data: 1, type: 'text', title: 'Product', width: 100 },
            { data: 2, type: 'text', title: 'Campaign Name', width: 150 },
            { data: 3, type: 'text', title: 'Ad Set Name', width: 150 },
            { data: 4, type: 'numeric', title: 'Ad Spend ‚Ç¨', numericFormat: { pattern: '0,0.00' }, width: 100 },
            { data: 5, type: 'numeric', title: 'Impressions', numericFormat: { pattern: '0,0' }, width: 100 },
            { data: 6, type: 'numeric', title: 'Clicks', numericFormat: { pattern: '0,0' }, width: 80 },
            { data: 7, type: 'numeric', title: 'CTR %', numericFormat: { pattern: '0.00' }, width: 80 },
            { data: 8, type: 'numeric', title: 'CPC', numericFormat: { pattern: '0.00' }, width: 80 },
            { data: 9, type: 'numeric', title: 'CPM', numericFormat: { pattern: '0.00' }, width: 80 },
            { data: 10, type: 'numeric', title: 'CVR', numericFormat: { pattern: '0.00' }, width: 80 },
            { data: 11, type: 'numeric', title: 'CPA', numericFormat: { pattern: '0.00' }, width: 80 },
            { data: 12, type: 'numeric', title: 'Sales Revenue', numericFormat: { pattern: '0,0.00' }, width: 120 },
            { data: 13, type: 'numeric', title: 'AOV', numericFormat: { pattern: '0.00' }, width: 80 },
            { data: 14, type: 'numeric', title: 'Orders Total', numericFormat: { pattern: '0' }, width: 100 },
            { data: 15, type: 'text', title: 'Check', width: 60 },
            { data: 16, type: 'numeric', title: '1-Pack Orders', numericFormat: { pattern: '0' }, width: 90 },
            { data: 17, type: 'numeric', title: '2-Pack Orders', numericFormat: { pattern: '0' }, width: 90 },
            { data: 18, type: 'numeric', title: '3-Pack Orders', numericFormat: { pattern: '0' }, width: 90 },
            { data: 19, type: 'numeric', title: '4-Pack Orders', numericFormat: { pattern: '0' }, width: 90 },
            { data: 20, type: 'numeric', title: '5-Pack Orders', numericFormat: { pattern: '0' }, width: 90 },
            { data: 21, type: 'numeric', title: '6-Pack Orders', numericFormat: { pattern: '0' }, width: 90 },
            { data: 22, type: 'text', title: 'COG Currency', width: 80 },
            { data: 23, type: 'numeric', title: 'COGS $', numericFormat: { pattern: '0,0.00' }, width: 100 },
            { data: 24, type: 'numeric', title: 'COGS ‚Ç¨', numericFormat: { pattern: '0,0.00' }, width: 100 },
            { data: 25, type: 'numeric', title: 'Payment VAT', numericFormat: { pattern: '0,0.00' }, width: 100 },
            { data: 26, type: 'numeric', title: 'Shopify Order Fee', numericFormat: { pattern: '0.00' }, width: 120 },
            { data: 27, type: 'numeric', title: 'Provision Rate', numericFormat: { pattern: '0.00' }, width: 100 },
            { data: 28, type: 'numeric', title: 'Refund Provision', numericFormat: { pattern: '0.00' }, width: 120 },
            { data: 29, type: 'numeric', title: 'Adj Net Revenue', numericFormat: { pattern: '0,0.00' }, width: 130 },
            { data: 30, type: 'numeric', title: 'Adj Gross Profit', numericFormat: { pattern: '0,0.00' }, width: 130 },
            { data: 31, type: 'numeric', title: 'Gross Margin %', numericFormat: { pattern: '0.00' }, width: 120 },
            { data: 32, type: 'numeric', title: 'Adj Net Profit', numericFormat: { pattern: '0,0.00' }, width: 130 },
            { data: 33, type: 'numeric', title: 'Net Margin %', numericFormat: { pattern: '0.00' }, width: 120 },
            { data: 34, type: 'numeric', title: 'Ads ROI', numericFormat: { pattern: '0.00' }, width: 100 },
            { data: 35, type: 'text', title: 'Notes', width: 200 }
        ];

        // Initialize Spreadsheet
        function initializeSpreadsheet() {
            const container = document.getElementById('spreadsheet');
            const isViewOnly = currentUser.role === 'viewer';

            hot = new Handsontable(container, {
                data: [],
                columns: columns,
                rowHeaders: true,
                colHeaders: true,
                height: 500,
                licenseKey: 'non-commercial-and-evaluation',
                stretchH: 'all',
                contextMenu: !isViewOnly,
                filters: true,
                dropdownMenu: true,
                manualColumnResize: true,
                readOnly: isViewOnly,
                afterChange: function(changes, source) {
                    if (source !== 'loadData' && !previewMode && !isViewOnly) {
                        calculateMetrics();
                        updateDashboard();
                        autoSave();
                    }
                }
            });
            loadData();
        }

        // Calculate Metrics
        function calculateMetrics() {
            const data = hot.getData();
            data.forEach((row, index) => {
                if (row[5] && row[6]) hot.setDataAtCell(index, 7, (row[6] / row[5]) * 100);
                if (row[4] && row[6]) hot.setDataAtCell(index, 8, row[4] / row[6]);
                if (row[4] && row[5]) hot.setDataAtCell(index, 9, (row[4] / row[5]) * 1000);
                if (row[12] && row[14]) hot.setDataAtCell(index, 13, row[12] / row[14]);
                if (row[4] && row[14]) hot.setDataAtCell(index, 11, row[4] / row[14]);
                if (row[12]) {
                    const adjNetRevenue = row[12] - (row[28] || 0);
                    hot.setDataAtCell(index, 29, adjNetRevenue);
                }
                if (row[29] && row[24]) {
                    const adjGrossProfit = row[29] - row[24];
                    hot.setDataAtCell(index, 30, adjGrossProfit);
                }
                if (row[30] && row[29]) {
                    hot.setDataAtCell(index, 31, (row[30] / row[29]) * 100);
                }
                if (row[30] && row[4]) {
                    const adjNetProfit = row[30] - row[4] - (row[26] || 0) - (row[25] || 0);
                    hot.setDataAtCell(index, 32, adjNetProfit);
                }
                if (row[32] && row[29]) {
                    hot.setDataAtCell(index, 33, (row[32] / row[29]) * 100);
                }
                if (row[32] && row[4]) {
                    hot.setDataAtCell(index, 34, (row[32] / row[4]) * 100);
                }
            });
        }

        // Update Dashboard
        function updateDashboard() {
            const data = hot.getData();
            let totalSpend = 0, totalRevenue = 0, totalOrders = 0, totalProfit = 0;

            data.forEach(row => {
                totalSpend += row[4] || 0;
                totalRevenue += row[12] || 0;
                totalOrders += row[14] || 0;
                totalProfit += row[32] || 0;
            });

            document.getElementById('rawDataCount').textContent = data.length;
            document.getElementById('fbAdsSpend').textContent = '‚Ç¨' + totalSpend.toFixed(2);
            document.getElementById('totalRevenue').textContent = '‚Ç¨' + totalRevenue.toFixed(2);
            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('netProfit').textContent = '‚Ç¨' + totalProfit.toFixed(2);
        }

        // Data Storage Key
        function getStorageKey() {
            return `asipu_${currentDomain}_${currentYear}_${currentMonth}`;
        }

        // Version History Key
        function getVersionHistoryKey() {
            return `asipu_history_${currentDomain}_${currentYear}_${currentMonth}`;
        }

        // Save Version to History
        function saveVersionToHistory(data) {
            const historyKey = getVersionHistoryKey();
            let history = JSON.parse(localStorage.getItem(historyKey) || '[]');

            const version = {
                timestamp: new Date().toISOString(),
                user: currentUser.displayName,
                data: JSON.stringify(data),
                id: Date.now()
            };

            history.unshift(version);
            if (history.length > 50) history = history.slice(0, 50);

            localStorage.setItem(historyKey, JSON.stringify(history));
        }

        // Save Data
        function saveData() {
            if (previewMode) {
                alert('‚ö†Ô∏è Cannot save in preview mode.');
                return;
            }
            if (currentUser.role === 'viewer') {
                alert('‚ö†Ô∏è You do not have permission to save data.');
                return;
            }

            const data = hot.getData();
            localStorage.setItem(getStorageKey(), JSON.stringify(data));
            saveVersionToHistory(data);
            alert('‚úÖ Data saved successfully!');
        }

        // Load Data
        function loadData() {
            const saved = localStorage.getItem(getStorageKey());
            const data = saved ? JSON.parse(saved) : [generateEmptyRow()];
            hot.loadData(data);
            calculateMetrics();
            updateDashboard();
        }

        // Auto Save
        function autoSave() {
            if (previewMode || currentUser.role === 'viewer') return;

            const data = hot.getData();
            localStorage.setItem(getStorageKey(), JSON.stringify(data));
            saveVersionToHistory(data);
        }

        // Generate Empty Row
        function generateEmptyRow() {
            const date = new Date(currentYear, currentMonth, 1).toISOString().split('T')[0];
            return [date, '', '', '', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, '', 0, 0, 0, 0, 0, 0, 'USD', 0, 0, 0, 0, 0.1, 0, 0, 0, 0, 0, 0, 0, ''];
        }

        // Add Row
        function addRow() {
            if (previewMode || currentUser.role === 'viewer') {
                alert('‚ö†Ô∏è You cannot add rows.');
                return;
            }
            const newRow = generateEmptyRow();
            hot.alter('insert_row_below', hot.countRows());
            hot.populateFromArray(hot.countRows() - 1, 0, [newRow]);
        }

        // Export to Excel
        function exportToExcel() {
            const data = hot.getData();
            const headers = columns.map(col => col.title);
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            const wb = XLSX.utils.book_new();
            const fileName = `${currentDomain}_${currentYear}_${months[currentMonth]}.xlsx`;
            XLSX.utils.book_append_sheet(wb, ws, 'Raw Data');
            XLSX.writeFile(wb, fileName);
        }

        // Import Excel
        function importExcel(event) {
            if (previewMode || currentUser.role === 'viewer') {
                alert('‚ö†Ô∏è You cannot import data.');
                return;
            }
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    jsonData.shift();
                    hot.loadData(jsonData);
                    calculateMetrics();
                    updateDashboard();
                    alert('‚úÖ File imported!');
                };
                reader.readAsArrayBuffer(file);
            }
        }

        // Version History Functions
        function openVersionHistory() {
            document.getElementById('versionHistorySidebar').classList.add('open');
            loadVersionHistory();
        }

        function closeVersionHistory() {
            document.getElementById('versionHistorySidebar').classList.remove('open');
            if (previewMode) exitPreviewMode();
        }

        function loadVersionHistory() {
            const historyKey = getVersionHistoryKey();
            const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            const container = document.getElementById('versionList');

            if (history.length === 0) {
                container.innerHTML = '<div class="no-versions">No version history available yet.</div>';
                return;
            }

            container.innerHTML = '';

            history.forEach((version, index) => {
                const item = document.createElement('div');
                item.className = 'version-item';
                if (index === 0) item.classList.add('active');

                const date = new Date(version.timestamp);
                const timeStr = date.toLocaleString();

                item.innerHTML = `
                    <div class="version-time">
                        ${timeStr}
                        ${index === 0 ? '<span class="current-version-badge">CURRENT</span>' : ''}
                    </div>
                    <div class="version-user">Edited by: ${version.user}</div>
                    <div class="version-actions">
                        <button class="preview-btn" onclick="previewVersion(${version.id})">üëÅÔ∏è Preview</button>
                        ${index !== 0 && currentUser.role !== 'viewer' ? `<button class="restore-btn" onclick="restoreVersion(${version.id})">‚Ü©Ô∏è Restore</button>` : ''}
                    </div>
                `;

                container.appendChild(item);
            });
        }

        function previewVersion(versionId) {
            const historyKey = getVersionHistoryKey();
            const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            const version = history.find(v => v.id === versionId);

            if (version) {
                previewMode = true;
                document.getElementById('previewBanner').classList.add('active');
                const data = JSON.parse(version.data);
                hot.loadData(data);
                calculateMetrics();
                updateDashboard();
            }
        }

        function exitPreviewMode() {
            if (previewMode) {
                previewMode = false;
                document.getElementById('previewBanner').classList.remove('active');
                loadData();
            }
        }

        function restoreVersion(versionId) {
            if (currentUser.role === 'viewer') {
                alert('‚ö†Ô∏è You do not have permission to restore versions.');
                return;
            }

            if (!confirm('Restore this version? Current data will be replaced.')) return;

            const historyKey = getVersionHistoryKey();
            const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            const version = history.find(v => v.id === versionId);

            if (version) {
                const data = JSON.parse(version.data);
                localStorage.setItem(getStorageKey(), JSON.stringify(data));
                saveVersionToHistory(data);

                exitPreviewMode();
                loadData();
                closeVersionHistory();

                alert('‚úÖ Version restored!');
            }
        }

        setInterval(autoSave, 30000);
    </script>
</body>
</html>
