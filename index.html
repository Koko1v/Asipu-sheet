<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asipu Analytics Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.1.0/dist/handsontable.full.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 400px;
        }

        .login-box h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .login-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 16px;
        }

        .login-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-box button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-box button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .error-msg {
            color: #ef4444;
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        /* Main Dashboard */
        #app {
            display: none;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            font-size: 16px;
        }

        .logout-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: white;
            color: #667eea;
        }

        /* Version History Sidebar */
        .version-history-sidebar {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            transition: right 0.3s;
            z-index: 1000;
            overflow-y: auto;
        }

        .version-history-sidebar.open {
            right: 0;
        }

        .version-history-header {
            background: #667eea;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .version-history-header h2 {
            font-size: 20px;
        }

        .close-history-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .version-list {
            padding: 0;
        }

        .version-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
        }

        .version-item:hover {
            background: #f9fafb;
        }

        .version-item.active {
            background: #eff6ff;
            border-left: 4px solid #667eea;
        }

        .version-time {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .version-user {
            font-size: 12px;
            color: #9ca3af;
        }

        .version-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .restore-btn, .preview-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .restore-btn {
            background: #10b981;
            color: white;
        }

        .restore-btn:hover {
            background: #059669;
        }

        .preview-btn {
            background: #667eea;
            color: white;
        }

        .preview-btn:hover {
            background: #5568d3;
        }

        .current-version-badge {
            background: #fbbf24;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }

        .no-versions {
            padding: 40px 20px;
            text-align: center;
            color: #9ca3af;
        }

        /* Domain Selection */
        .domain-tabs {
            display: flex;
            gap: 10px;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .domain-tab {
            padding: 15px 30px;
            background: #e5e7eb;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .domain-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .domain-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Year and Month Navigation */
        .time-navigation {
            padding: 20px;
            background: white;
            margin: 0 20px;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .nav-section {
            margin-bottom: 15px;
        }

        .nav-label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            font-size: 14px;
        }

        .year-buttons, .month-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .year-btn, .month-btn {
            padding: 10px 20px;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .year-btn.active, .month-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .year-btn:hover, .month-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
        }

        /* Stats Dashboard */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
        }

        /* Toolbar */
        .toolbar {
            background: white;
            padding: 15px 20px;
            margin: 0 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: #f59e0b;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        /* Spreadsheet Container */
        .container {
            padding: 0 20px 20px 20px;
        }

        #spreadsheet {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .file-input {
            display: none;
        }

        .current-view {
            padding: 15px 20px;
            background: #f9fafb;
            margin: 0 20px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            color: #667eea;
            font-size: 18px;
        }

        .preview-mode-banner {
            background: #fbbf24;
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .preview-mode-banner.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h1>üîê Asipu Analytics</h1>
            <input type="text" id="username" placeholder="Username" />
            <input type="password" id="password" placeholder="Password" />
            <button onclick="login()">Login</button>
            <div class="error-msg" id="errorMsg">Invalid credentials</div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app">
        <div class="header">
            <h1>üìä Asipu Analytics Dashboard</h1>
            <div class="user-info">
                <span class="user-name" id="userName"></span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Preview Mode Banner -->
        <div class="preview-mode-banner" id="previewBanner">
            üìã PREVIEW MODE - Viewing previous version
        </div>

        <!-- Version History Sidebar -->
        <div class="version-history-sidebar" id="versionHistorySidebar">
            <div class="version-history-header">
                <h2>üìú Version History</h2>
                <button class="close-history-btn" onclick="closeVersionHistory()">‚úï</button>
            </div>
            <div class="version-list" id="versionList"></div>
        </div>

        <!-- Domain Selection -->
        <div class="domain-tabs">
            <button class="domain-tab active" onclick="switchDomain('asipu.de')">Asipu.de</button>
            <button class="domain-tab" onclick="switchDomain('asipu.fi')">Asipu.fi</button>
        </div>

        <!-- Year and Month Navigation -->
        <div class="time-navigation">
            <div class="nav-section">
                <div class="nav-label">Select Year:</div>
                <div class="year-buttons" id="yearButtons"></div>
            </div>
            <div class="nav-section">
                <div class="nav-label">Select Month:</div>
                <div class="month-buttons" id="monthButtons"></div>
            </div>
        </div>

        <div class="current-view" id="currentView">Asipu.de - 2025 - January - Day View</div>

        <!-- Stats Dashboard -->
        <div class="stats" id="stats">
            <div class="stat-card">
                <h3>Total Ad Spend</h3>
                <div class="value" id="totalSpend">‚Ç¨0</div>
            </div>
            <div class="stat-card">
                <h3>Total Revenue</h3>
                <div class="value" id="totalRevenue">‚Ç¨0</div>
            </div>
            <div class="stat-card">
                <h3>Total Orders</h3>
                <div class="value" id="totalOrders">0</div>
            </div>
            <div class="stat-card">
                <h3>Net Profit</h3>
                <div class="value" id="totalProfit">‚Ç¨0</div>
            </div>
            <div class="stat-card">
                <h3>Average ROI</h3>
                <div class="value" id="avgROI">0%</div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <button class="btn" onclick="addRow()">‚ûï Add Day</button>
            <button class="btn" onclick="saveData()">üíæ Save Data</button>
            <button class="btn btn-warning" onclick="openVersionHistory()">üìú Version History</button>
            <button class="btn btn-success" onclick="exportToExcel()">üì• Export Excel</button>
            <label for="file-upload" class="btn">üìÇ Import Excel</label>
            <input id="file-upload" type="file" class="file-input" accept=".xlsx,.xls" onchange="importExcel(event)">
        </div>

        <!-- Spreadsheet -->
        <div class="container">
            <div id="spreadsheet"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/handsontable@13.1.0/dist/handsontable.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // User Management System
        const users = {
            'admin': 'admin123',
            'worker1': 'worker1',
            'worker2': 'worker2',
            'manager': 'manager123'
        };

        // Check if user is logged in
        window.onload = function() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                showApp(loggedInUser);
            }
        };

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (users[username] && users[username] === password) {
                localStorage.setItem('loggedInUser', username);
                showApp(username);
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
        }

        function showApp(username) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('userName').textContent = 'User: ' + username;
            initializeApp();
        }

        function logout() {
            localStorage.removeItem('loggedInUser');
            location.reload();
        }

        // Application State
        let currentDomain = 'asipu.de';
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let hot;
        let previewMode = false;

        const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];

        // Initialize App
        function initializeApp() {
            generateYearButtons();
            generateMonthButtons();
            initializeSpreadsheet();
            updateCurrentView();
        }

        // Generate Year Buttons
        function generateYearButtons() {
            const container = document.getElementById('yearButtons');
            const currentYearNum = new Date().getFullYear();

            for (let year = currentYearNum - 2; year <= currentYearNum + 2; year++) {
                const btn = document.createElement('button');
                btn.className = 'year-btn' + (year === currentYear ? ' active' : '');
                btn.textContent = year;
                btn.onclick = () => selectYear(year);
                container.appendChild(btn);
            }
        }

        // Generate Month Buttons
        function generateMonthButtons() {
            const container = document.getElementById('monthButtons');
            months.forEach((month, index) => {
                const btn = document.createElement('button');
                btn.className = 'month-btn' + (index === currentMonth ? ' active' : '');
                btn.textContent = month;
                btn.onclick = () => selectMonth(index);
                container.appendChild(btn);
            });
        }

        // Switch Domain
        function switchDomain(domain) {
            currentDomain = domain;
            document.querySelectorAll('.domain-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase().includes(domain)) {
                    tab.classList.add('active');
                }
            });
            exitPreviewMode();
            loadData();
            updateCurrentView();
        }

        // Select Year
        function selectYear(year) {
            currentYear = year;
            document.querySelectorAll('.year-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent == year) {
                    btn.classList.add('active');
                }
            });
            exitPreviewMode();
            loadData();
            updateCurrentView();
        }

        // Select Month
        function selectMonth(monthIndex) {
            currentMonth = monthIndex;
            document.querySelectorAll('.month-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.month-btn')[monthIndex].classList.add('active');
            exitPreviewMode();
            loadData();
            updateCurrentView();
        }

        // Update Current View Display
        function updateCurrentView() {
            const view = `${currentDomain.toUpperCase()} - ${currentYear} - ${months[currentMonth]} - Daily View`;
            document.getElementById('currentView').textContent = view;
        }

        // Column Configuration (Daily tracking)
        const columns = [
            { data: 0, type: 'date', dateFormat: 'YYYY-MM-DD', title: 'Date', width: 100 },
            { data: 1, type: 'text', title: 'Product', width: 100 },
            { data: 2, type: 'text', title: 'Campaign', width: 150 },
            { data: 3, type: 'numeric', title: 'Ad Spend ‚Ç¨', numericFormat: { pattern: '0,0.00' }, width: 100 },
            { data: 4, type: 'numeric', title: 'Impressions', numericFormat: { pattern: '0,0' }, width: 100 },
            { data: 5, type: 'numeric', title: 'Clicks', numericFormat: { pattern: '0,0' }, width: 80 },
            { data: 6, type: 'numeric', title: 'CTR %', numericFormat: { pattern: '0.00' }, width: 80 },
            { data: 7, type: 'numeric', title: 'CPC', numericFormat: { pattern: '0.00' }, width: 80 },
            { data: 8, type: 'numeric', title: 'Revenue ‚Ç¨', numericFormat: { pattern: '0,0.00' }, width: 100 },
            { data: 9, type: 'numeric', title: 'Orders', numericFormat: { pattern: '0' }, width: 80 },
            { data: 10, type: 'numeric', title: 'AOV', numericFormat: { pattern: '0.00' }, width: 80 },
            { data: 11, type: 'numeric', title: 'COGS ‚Ç¨', numericFormat: { pattern: '0,0.00' }, width: 100 },
            { data: 12, type: 'numeric', title: 'Gross Profit ‚Ç¨', numericFormat: { pattern: '0,0.00' }, width: 120 },
            { data: 13, type: 'numeric', title: 'Net Profit ‚Ç¨', numericFormat: { pattern: '0,0.00' }, width: 120 },
            { data: 14, type: 'numeric', title: 'ROI %', numericFormat: { pattern: '0.00' }, width: 80 },
            { data: 15, type: 'text', title: 'Notes', width: 200 }
        ];

        // Initialize Spreadsheet
        function initializeSpreadsheet() {
            const container = document.getElementById('spreadsheet');
            hot = new Handsontable(container, {
                data: [],
                columns: columns,
                rowHeaders: true,
                colHeaders: true,
                height: 500,
                licenseKey: 'non-commercial-and-evaluation',
                stretchH: 'all',
                contextMenu: true,
                filters: true,
                dropdownMenu: true,
                manualColumnResize: true,
                afterChange: function(changes, source) {
                    if (source !== 'loadData' && !previewMode) {
                        calculateMetrics();
                        updateStats();
                        autoSave();
                    }
                }
            });
            loadData();
        }

        // Calculate Metrics
        function calculateMetrics() {
            const data = hot.getData();
            data.forEach((row, index) => {
                if (row[4] && row[5]) {
                    hot.setDataAtCell(index, 6, (row[5] / row[4]) * 100);
                }
                if (row[3] && row[5]) {
                    hot.setDataAtCell(index, 7, row[3] / row[5]);
                }
                if (row[8] && row[9]) {
                    hot.setDataAtCell(index, 10, row[8] / row[9]);
                }
                if (row[8] && row[11]) {
                    hot.setDataAtCell(index, 12, row[8] - row[11]);
                }
                if (row[12] && row[3]) {
                    hot.setDataAtCell(index, 13, row[12] - row[3]);
                }
                if (row[13] && row[3]) {
                    hot.setDataAtCell(index, 14, (row[13] / row[3]) * 100);
                }
            });
        }

        // Update Stats
        function updateStats() {
            const data = hot.getData();
            let totalSpend = 0, totalRevenue = 0, totalOrders = 0, totalProfit = 0, roiSum = 0, roiCount = 0;

            data.forEach(row => {
                totalSpend += row[3] || 0;
                totalRevenue += row[8] || 0;
                totalOrders += row[9] || 0;
                totalProfit += row[13] || 0;
                if (row[14]) {
                    roiSum += row[14];
                    roiCount++;
                }
            });

            document.getElementById('totalSpend').textContent = '‚Ç¨' + totalSpend.toFixed(2);
            document.getElementById('totalRevenue').textContent = '‚Ç¨' + totalRevenue.toFixed(2);
            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('totalProfit').textContent = '‚Ç¨' + totalProfit.toFixed(2);
            document.getElementById('avgROI').textContent = roiCount > 0 ? (roiSum / roiCount).toFixed(2) + '%' : '0%';
        }

        // Data Storage Key
        function getStorageKey() {
            return `asipu_${currentDomain}_${currentYear}_${currentMonth}`;
        }

        // Version History Key
        function getVersionHistoryKey() {
            return `asipu_history_${currentDomain}_${currentYear}_${currentMonth}`;
        }

        // Save Version to History
        function saveVersionToHistory(data) {
            const historyKey = getVersionHistoryKey();
            let history = JSON.parse(localStorage.getItem(historyKey) || '[]');

            const version = {
                timestamp: new Date().toISOString(),
                user: localStorage.getItem('loggedInUser'),
                data: JSON.stringify(data),
                id: Date.now()
            };

            history.unshift(version); // Add to beginning

            // Keep last 50 versions
            if (history.length > 50) {
                history = history.slice(0, 50);
            }

            localStorage.setItem(historyKey, JSON.stringify(history));
        }

        // Save Data
        function saveData() {
            if (previewMode) {
                alert('‚ö†Ô∏è Cannot save in preview mode. Exit preview first.');
                return;
            }

            const data = hot.getData();
            localStorage.setItem(getStorageKey(), JSON.stringify(data));
            saveVersionToHistory(data);
            alert('‚úÖ Data saved successfully for ' + months[currentMonth] + ' ' + currentYear + '!');
        }

        // Load Data
        function loadData() {
            const saved = localStorage.getItem(getStorageKey());
            const data = saved ? JSON.parse(saved) : [generateEmptyRow()];
            hot.loadData(data);
            calculateMetrics();
            updateStats();
        }

        // Auto Save
        function autoSave() {
            if (previewMode) return;

            const data = hot.getData();
            localStorage.setItem(getStorageKey(), JSON.stringify(data));
            saveVersionToHistory(data);
        }

        // Generate Empty Row
        function generateEmptyRow() {
            const date = new Date(currentYear, currentMonth, 1).toISOString().split('T')[0];
            return [date, '', '', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ''];
        }

        // Add Row
        function addRow() {
            if (previewMode) {
                alert('‚ö†Ô∏è Cannot add rows in preview mode.');
                return;
            }
            const newRow = generateEmptyRow();
            hot.alter('insert_row_below', hot.countRows());
            hot.populateFromArray(hot.countRows() - 1, 0, [newRow]);
        }

        // Export to Excel
        function exportToExcel() {
            const data = hot.getData();
            const headers = columns.map(col => col.title);
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            const wb = XLSX.utils.book_new();
            const fileName = `${currentDomain}_${currentYear}_${months[currentMonth]}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.utils.book_append_sheet(wb, ws, months[currentMonth]);
            XLSX.writeFile(wb, fileName);
        }

        // Import Excel
        function importExcel(event) {
            if (previewMode) {
                alert('‚ö†Ô∏è Cannot import in preview mode.');
                return;
            }
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    jsonData.shift();
                    hot.loadData(jsonData);
                    calculateMetrics();
                    updateStats();
                    alert('‚úÖ File imported successfully!');
                };
                reader.readAsArrayBuffer(file);
            }
        }

        // ========== VERSION HISTORY FUNCTIONS ==========

        // Open Version History
        function openVersionHistory() {
            document.getElementById('versionHistorySidebar').classList.add('open');
            loadVersionHistory();
        }

        // Close Version History
        function closeVersionHistory() {
            document.getElementById('versionHistorySidebar').classList.remove('open');
            if (previewMode) {
                exitPreviewMode();
            }
        }

        // Load Version History List
        function loadVersionHistory() {
            const historyKey = getVersionHistoryKey();
            const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            const container = document.getElementById('versionList');

            if (history.length === 0) {
                container.innerHTML = '<div class="no-versions">No version history available yet.<br>Changes will be tracked automatically.</div>';
                return;
            }

            container.innerHTML = '';

            history.forEach((version, index) => {
                const item = document.createElement('div');
                item.className = 'version-item';
                if (index === 0) {
                    item.classList.add('active');
                }

                const date = new Date(version.timestamp);
                const timeStr = date.toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                item.innerHTML = `
                    <div class="version-time">
                        ${timeStr}
                        ${index === 0 ? '<span class="current-version-badge">CURRENT</span>' : ''}
                    </div>
                    <div class="version-user">Edited by: ${version.user}</div>
                    <div class="version-actions">
                        <button class="preview-btn" onclick="previewVersion(${version.id})">üëÅÔ∏è Preview</button>
                        ${index !== 0 ? `<button class="restore-btn" onclick="restoreVersion(${version.id})">‚Ü©Ô∏è Restore</button>` : ''}
                    </div>
                `;

                container.appendChild(item);
            });
        }

        // Preview Version
        function previewVersion(versionId) {
            const historyKey = getVersionHistoryKey();
            const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            const version = history.find(v => v.id === versionId);

            if (version) {
                previewMode = true;
                document.getElementById('previewBanner').classList.add('active');
                const data = JSON.parse(version.data);
                hot.loadData(data);
                calculateMetrics();
                updateStats();
            }
        }

        // Exit Preview Mode
        function exitPreviewMode() {
            if (previewMode) {
                previewMode = false;
                document.getElementById('previewBanner').classList.remove('active');
                loadData();
            }
        }

        // Restore Version
        function restoreVersion(versionId) {
            if (!confirm('Are you sure you want to restore this version? Current data will be replaced.')) {
                return;
            }

            const historyKey = getVersionHistoryKey();
            const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            const version = history.find(v => v.id === versionId);

            if (version) {
                const data = JSON.parse(version.data);
                localStorage.setItem(getStorageKey(), JSON.stringify(data));
                saveVersionToHistory(data); // Save restoration as new version

                exitPreviewMode();
                loadData();
                closeVersionHistory();

                alert('‚úÖ Version restored successfully!');
            }
        }

        // Auto-save interval
        setInterval(autoSave, 30000);
    </script>
</body>
</html>
